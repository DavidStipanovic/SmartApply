<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<body th:with="activePage='dashboard'">

<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<main class="main-content">
    <div class="container">

        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <span th:text="${greeting}">Hallo</span>,
                    <span th:text="${#authentication.principal instanceof T(com.dave.smartapply.model.User) ? #authentication.principal.firstName : #authentication.name}">Dave</span>
                </h1>
                <p style="color: var(--text-secondary); margin: 0;">Hier ist deine Ãœbersicht fÃ¼r heute</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; align-items: start;">

            <div style="display: flex; flex-direction: column; gap: 30px;">

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-bolt"></i> Schnellaktionen</h2>
                    </div>
                    <div class="card-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <a href="/applications/new" class="quick-action-btn btn-primary-soft">
                            <i class="fas fa-briefcase"></i> <span>Bewerbung</span>
                        </a>
                        <button onclick="openNoteModal()" class="quick-action-btn btn-yellow-soft">
                            <i class="fas fa-sticky-note"></i> <span>Notiz</span>
                        </button>
                        <a href="#" onclick="alert('Upload Modul folgt bald!')" class="quick-action-btn btn-blue-soft">
                            <i class="fas fa-cloud-upload-alt"></i> <span>Upload</span>
                        </a>
                        <a href="/profile" class="quick-action-btn btn-gray-soft">
                            <i class="fas fa-user-cog"></i> <span>Profil</span>
                        </a>
                    </div>
                </div>

                <div class="card" onclick="window.location.href='/calendar'" style="cursor: pointer;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Ãœbersicht</h2>
                    </div>
                    <div class="card-body" style="padding: 10px 15px;">
                        <div id="miniCalendar"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h2 class="card-title"><i class="fas fa-folder-open"></i> Dokumente</h2></div>
                    <div class="card-body" style="text-align: center; padding: 20px;">
                        <p style="color: var(--text-secondary);">Dokumentenverwaltung folgt...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Neueste Bewerbungen</h2>
                        <a href="/applications" class="btn btn-secondary btn-sm">
                            Alle anzeigen <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                    <div class="card-body">
                        <div th:if="${recentApplications != null and !recentApplications.isEmpty()}">
                            <div class="applications-grid">
                                <div th:each="app : ${recentApplications}" class="application-card"
                                     th:onclick="'window.location.href=\'/applications/' + ${app.id} + '\''">
                                    <div class="application-header">
                                        <div>
                                            <h3 class="company-name" th:text="${app.companyName}">Firma</h3>
                                            <p class="position-title" th:text="${app.position}">Position</p>
                                        </div>
                                        <span th:class="'status-badge status-' + ${#strings.toLowerCase(app.status)}"
                                              th:text="${app.status?.displayName ?: 'Unbekannt'}">Status</span>
                                    </div>
                                    <div class="application-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-calendar meta-icon"></i>
                                            <span th:text="${#temporals.format(app.applicationDate, 'dd.MM.yyyy')}">Datum</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${recentApplications == null or recentApplications.isEmpty()}" class="empty-state">
                            <div class="empty-icon">ðŸ“­</div>
                            <h3>Noch keine Bewerbungen</h3>
                            <a href="/applications/new" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus"></i> Erste Bewerbung erstellen
                            </a>
                        </div>
                    </div>
                </div>

            </div>

            <div style="display: flex; flex-direction: column; gap: 30px;">
                <div class="weather-card">
                    <div class="container-img">
                        <div class="cloud front"><span class="left-front"></span><span class="right-front"></span></div>
                        <span class="sun sunshine"></span>
                        <span class="sun"></span>
                        <div class="cloud back"><span class="left-back"></span><span class="right-back"></span></div>
                    </div>
                    <div class="weather-card-header">
                        <span id="weatherLocation">Lade Standort...</span>
                        <span id="weatherDate">Datum...</span>
                    </div>
                    <span id="weatherTemp" class="temp">--Â°</span>
                </div>

                <div class="card" onclick="window.location.href='/notes'"
                     style="cursor: pointer; transition: transform 0.2s; text-align: center; padding: 30px 0;">
                    <div class="card-header" style="justify-content: center;">
                        <h2 class="card-title"><i class="fas fa-layer-group"></i> Meine Notizen</h2>
                    </div>
                    <div class="card-body">
                        <div style="position: relative; width: 60px; height: 60px; margin: 0 auto 10px auto;">
                            <i class="fas fa-sticky-note" style="font-size: 3rem; color: #fef3c7; position: absolute; top: 0; left: 10px; transform: rotate(5deg);"></i>
                            <i class="fas fa-sticky-note" style="font-size: 3rem; color: #fcd34d; position: absolute; top: 5px; left: 0; transform: rotate(-5deg);"></i>
                        </div>
                        <p style="color: var(--text-primary); font-weight: 600;">Alle Notizen anzeigen</p>
                    </div>
                </div>

            </div>
        </div>

    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<div id="noteModal" class="modal-overlay">
    <div class="modal-card" id="noteCard">
        <div class="modal-header">
            <h3 class="modal-title">Schnelle Notiz</h3>
            <button onclick="closeNoteModal()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">&times;</button>
        </div>
        <form id="noteForm">
            <div class="modal-body">
                <input type="hidden" name="color" id="noteColor" value="white">
                <input type="text" name="title" class="form-input" placeholder="Titel..." required>
                <textarea name="content" class="form-textarea" placeholder="Schreib was runter..." required></textarea>

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <div onclick="selectColor('white', this)" class="color-circle selected" style="background: #ffffff;"></div>
                    <div onclick="selectColor('red', this)" class="color-circle" style="background: #fecaca;"></div>
                    <div onclick="selectColor('yellow', this)" class="color-circle" style="background: #fef3c7;"></div>
                    <div onclick="selectColor('green', this)" class="color-circle" style="background: #bbf7d0;"></div>
                    <div onclick="selectColor('blue', this)" class="color-circle" style="background: #bfdbfe;"></div>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                <button type="button" onclick="saveNote()" class="btn btn-primary">Speichern</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. DATUM & WETTER ---
        const dateElement = document.getElementById('weatherDate');
        const now = new Date();
        const options = {day: 'numeric', month: 'long'};
        dateElement.textContent = now.toLocaleDateString('de-DE', options);

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=de`)
                    .then(response => response.json())
                    .then(data => {
                        const city = data.city || data.locality || "Dein Standort";
                        const country = data.countryName || "";
                        document.getElementById('weatherLocation').innerHTML = `${city}<br>${country}`;
                    });
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
                    .then(response => response.json())
                    .then(data => {
                        const temp = Math.round(data.current_weather.temperature);
                        document.getElementById('weatherTemp').textContent = `${temp}Â°`;
                    });
            }, function (error) {
                console.error("Standort Zugriff verweigert", error);
                document.getElementById('weatherLocation').textContent = "MÃ¼nchen (Demo)";
                document.getElementById('weatherTemp').textContent = "20Â°";
            });
        }

        // --- 2. MINI KALENDER INITIALISIERUNG ---
        var calendarEl = document.getElementById('miniCalendar');
        if (calendarEl) {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'de',
                height: 320,
                headerToolbar: {left: 'title', center: '', right: ''},
                events: '/api/calendar/events',
                dayHeaderFormat: {weekday: 'narrow'},
                fixedWeekCount: false,
                showNonCurrentDates: false,
                displayEventTime: false,
                dateClick: function () { window.location.href = '/calendar'; },
                eventClick: function () { window.location.href = '/calendar'; }
            });
            calendar.render();
        }
    });

    // --- MODAL FUNKTIONEN ---
    function openNoteModal() {
        const modal = document.getElementById('noteModal');
        if (modal) {
            modal.style.display = 'flex'; // Ã–ffnet mit Flexbox (Zentrierung durch style.css)
        }
    }

    function closeNoteModal() {
        document.getElementById('noteModal').style.display = 'none';
        document.getElementById('noteForm').reset();
        selectColor('white', null);
    }

    function selectColor(colorName, element) {
        document.getElementById('noteColor').value = colorName;
        const colorMap = { 'white': '#ffffff', 'red': '#fecaca', 'yellow': '#fef3c7', 'green': '#bbf7d0', 'blue': '#bfdbfe' };
        document.getElementById('noteCard').style.backgroundColor = colorMap[colorName];
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        if (element) element.classList.add('selected');
    }

    function saveNote() {
        const form = document.querySelector('#noteForm');
        const formData = new FormData(form);
        const token = localStorage.getItem('token');

        if (!token) { window.location.href = '/login'; return; }

        fetch('/notes/create', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(formData)
        })
            .then(response => {
                if (response.ok) {
                    closeNoteModal();
                    window.location.reload();
                } else {
                    console.error("Fehler beim Speichern");
                }
            });
    }
</script>

</body>
</html>