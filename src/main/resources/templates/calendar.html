<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<body th:with="activePage='calendar'">
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<main class="main-content">
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Dein Kalender</h1>
                <p style="color: var(--text-secondary);">Organisiere deine Termine und Fristen</p>
            </div>
            <button onclick="openModal()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Neuer Termin
            </button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div id='calendar' style="padding: 20px;"></div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<div id="eventModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">

        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Termin planen</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">&times;</button>
        </div>

        <form id="appointmentForm">
            <input type="hidden" name="id" id="eventId">

            <div class="modal-body">

                <div class="form-section">
                    <label class="form-label">Kategorie</label>
                    <input type="hidden" name="category" id="eventCategory" value="WORK">
                    <div style="display: flex; gap: 15px;">
                        <div onclick="selectCategory('WORK', this)" class="color-circle selected" style="background: #ef4444;" title="Arbeit"><i class="fas fa-briefcase"></i></div>
                        <div onclick="selectCategory('LEISURE', this)" class="color-circle" style="background: #3b82f6;" title="Freizeit"><i class="fas fa-umbrella-beach"></i></div>
                        <div onclick="selectCategory('IMPORTANT', this)" class="color-circle" style="background: #f59e0b;" title="Wichtig"><i class="fas fa-exclamation"></i></div>
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label">Titel / Betreff *</label>
                    <input type="text" name="title" id="eventTitle" class="modern-input" placeholder="z.B. Meeting" required>
                </div>

                <div class="form-grid-2">
                    <div>
                        <label class="form-label">Startdatum *</label>
                        <input type="date" name="startDate" id="startDate" class="modern-input" required>
                    </div>
                    <div>
                        <label class="form-label">Startzeit *</label>
                        <input type="time" name="startTime" id="startTime" class="modern-input" required>
                    </div>
                </div>

                <div class="form-grid-2">
                    <div>
                        <label class="form-label">Enddatum (Optional)</label>
                        <input type="date" name="endDate" id="endDate" class="modern-input">
                    </div>
                    <div>
                        <label class="form-label">Endzeit (Optional)</label>
                        <input type="time" name="endTime" id="endTime" class="modern-input">
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label"><i class="fas fa-map-marker-alt"></i> Ort / Link</label>
                    <input type="text" name="location" class="modern-input" placeholder="Ort oder Zoom-Link">
                </div>

                <div class="form-section">
                    <label class="form-label"><i class="fas fa-users"></i> Teilnehmer</label>
                    <input type="text" name="participants" class="modern-input" placeholder="E-Mails...">
                </div>

                <div class="form-section">
                    <label class="form-label">Notizen</label>
                    <textarea name="description" class="modern-textarea" style="min-height: 80px;" placeholder="Details..."></textarea>
                </div>

            </div>

            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <button type="button" id="deleteBtn" onclick="deleteAppointment()" class="btn btn-secondary" style="display: none; color: #ef4444; background: #fee2e2;">
                    <i class="fas fa-trash"></i> Löschen
                </button>

                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Abbrechen</button>
                    <button type="button" onclick="saveAppointment()" class="btn btn-primary">Speichern</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            locale: 'de',
            buttonText: {today: 'Heute', month: 'Monat', week: 'Woche', list: 'Liste'},
            height: 'auto',
            navLinks: true,
            editable: false,
            dayMaxEvents: true,
            events: '/api/calendar/events',

            // Klick auf leeres Feld -> Neuer Termin
            dateClick: function (info) {
                openModal(null, info.dateStr);
            },

            // Klick auf existierenden Termin -> Bearbeiten/Löschen
            eventClick: function (info) {
                openModal(info.event);
            }
        });
        calendar.render();
    });

    // Funktion zum Öffnen des Modals
    function openModal(event = null, dateStr = null) {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('appointmentForm');
        const deleteBtn = document.getElementById('deleteBtn');

        // Reset Form
        form.reset();

        if (event) {
            // EXISTIERENDER TERMIN
            document.getElementById('modalTitle').textContent = "Termin verwalten";
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTitle').value = event.title;
            // Hinweis: Für das korrekte Füllen von Datum/Zeit/Beschreibung bräuchte man hier
            // mehr Logik, um die Daten aus dem Event-Objekt zu parsen.
            // Das Löschen funktioniert aber über die ID.

            deleteBtn.style.display = 'block';
        } else {
            // NEUER TERMIN
            document.getElementById('modalTitle').textContent = "Neuen Termin planen";
            document.getElementById('eventId').value = "";
            deleteBtn.style.display = 'none';

            if (dateStr) {
                document.getElementById('startDate').value = dateStr;
            }
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('eventModal').style.display = 'none';
    }

    // Modal schließen beim Klick auf Hintergrund
    window.onclick = function (event) {
        if (event.target == document.getElementById('eventModal')) closeModal();
    }

    // --- SPEICHERN ---
    function saveAppointment() {
        const form = document.querySelector('#appointmentForm');
        const formData = new FormData(form);
        const urlSearchParams = new URLSearchParams(formData).toString();
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        fetch('/calendar/create', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: urlSearchParams
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/calendar';
                } else {
                    alert("Fehler beim Speichern.");
                }
            });
    }

    // --- LÖSCHEN ---
    function deleteAppointment() {
        const id = document.getElementById('eventId').value;
        if (!id) return;

        if (!confirm("Möchtest du diesen Termin wirklich löschen?")) return;

        const token = localStorage.getItem('token');

        fetch('/calendar/delete/' + id, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (response.ok) {
                    closeModal();
                    window.location.href = '/calendar';
                } else {
                    alert("Fehler beim Löschen.");
                }
            });
    }

    // Kategorie Auswahl (Farben)
    function selectCategory(value, element) {
        document.getElementById('eventCategory').value = value;
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');
    }
</script>

</body>
</html>