<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"></head>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

<body th:with="activePage='calendar'">
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<main class="main-content">
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Dein Kalender</h1>
                <p style="color: var(--text-secondary);">Organisiere deine Termine und Fristen</p>
            </div>
            <button onclick="openModal()" class="btn btn-primary">
                <i class="fas fa-plus"></i> Neuer Termin
            </button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div id='calendar' style="padding: 20px;"></div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<div id="eventModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="width: 100%; max-width: 800px;">

        <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
            <h3 class="modal-title" id="modalTitle" style="font-size: 1.5rem;">Termin planen</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size: 2rem; cursor:pointer; color: var(--text-secondary);">&times;</button>
        </div>

        <form id="appointmentForm">
            <input type="hidden" name="id" id="eventId">

            <div class="modal-body" style="padding-top: 10px;">

                <div class="form-section">
                    <input type="text" name="title" id="eventTitle" class="modern-input"
                           placeholder="Titel des Termins..." required
                           style="font-size: 1.3rem; padding: 15px; font-weight: 600; max-width: 100% !important;">
                </div>

                <div class="form-grid-2">
                    <div>
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Start</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" name="startDate" id="startDate" class="modern-input" required>
                            <input type="time" name="startTime" id="startTime" class="modern-input" required>
                        </div>
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Ende (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" name="endDate" id="endDate" class="modern-input">
                            <input type="time" name="endTime" id="endTime" class="modern-input">
                        </div>
                    </div>
                </div>

                <div class="form-grid-2">
                    <div>
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Ort / Link</label>
                        <input type="text" name="location" class="modern-input" placeholder="z.B. Zoom oder Büro">
                    </div>
                    <div>
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Teilnehmer</label>
                        <input type="text" name="participants" class="modern-input" placeholder="E-Mails...">
                    </div>
                </div>

                <div class="form-section">
                    <textarea name="description" class="modern-textarea"
                              style="min-height: 120px; font-size: 1rem; max-width: 100% !important;"
                              placeholder="Notizen oder Beschreibung hinzufügen..."></textarea>
                </div>

            </div>

            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05);">

                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 600;">Kategorie:</span>
                    <input type="hidden" name="category" id="eventCategory" value="WORK">

                    <div style="display: flex; gap: 10px;">
                        <div onclick="selectCategory('WORK', this)" class="color-circle selected"
                             style="background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c;"
                             title="Arbeit">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <div onclick="selectCategory('LEISURE', this)" class="color-circle"
                             style="background: #dbeafe; border: 2px solid #3b82f6; color: #1e40af;"
                             title="Freizeit">
                            <i class="fas fa-umbrella-beach"></i>
                        </div>
                        <div onclick="selectCategory('IMPORTANT', this)" class="color-circle"
                             style="background: #fef3c7; border: 2px solid #f59e0b; color: #b45309;"
                             title="Wichtig">
                            <i class="fas fa-exclamation"></i>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" id="deleteBtn" onclick="deleteAppointment()" class="btn btn-secondary"
                            style="color: #ef4444; background: #fee2e2; display: none; border: none;">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Abbrechen</button>
                    <button type="button" onclick="saveAppointment()" class="btn btn-primary">Speichern</button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    /* Spezifische Styles für die Kategorie-Kreise im Kalender (damit sie wie Tags aussehen) */
    .color-circle {
        width: 36px; height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.9rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .color-circle:hover {
        transform: translateY(-2px);
    }

    .color-circle.selected {
        transform: scale(1.15);
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }

    /* Input Inputs im Modal sollen 100% Breite haben für den "Notizen"-Look */
    #eventModal .modern-input,
    #eventModal .modern-textarea {
        max-width: 100% !important; /* Überschreibt die globale Begrenzung nur im Modal */
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            locale: 'de',
            buttonText: {today: 'Heute', month: 'Monat', week: 'Woche', list: 'Liste'},
            height: 'auto',
            navLinks: true,
            editable: false,
            dayMaxEvents: true,
            events: '/api/calendar/events',

            // Klick auf leeres Feld -> Neuer Termin
            dateClick: function (info) {
                openModal(null, info.dateStr);
            },

            // Klick auf existierenden Termin -> Bearbeiten/Löschen
            eventClick: function (info) {
                openModal(info.event);
            }
        });
        calendar.render();
    });

    // Funktion zum Öffnen des Modals
    function openModal(event = null, dateStr = null) {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('appointmentForm');
        const deleteBtn = document.getElementById('deleteBtn');

        // Reset Form
        form.reset();
        // Reset Categories
        selectCategory('WORK', document.querySelector('.color-circle[title="Arbeit"]'));

        if (event) {
            // EXISTIERENDER TERMIN
            document.getElementById('modalTitle').textContent = "Termin bearbeiten";
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTitle').value = event.title;
            // Hinweis: Datum/Zeit/Beschreibung müssten hier idealerweise via AJAX geholt werden
            // oder aus extendedProps kommen, wenn sie im Calendar-Event-Objekt sind.

            deleteBtn.style.display = 'block';
        } else {
            // NEUER TERMIN
            document.getElementById('modalTitle').textContent = "Neuen Termin planen";
            document.getElementById('eventId').value = "";
            deleteBtn.style.display = 'none';

            if (dateStr) {
                document.getElementById('startDate').value = dateStr;
            }
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('eventModal').style.display = 'none';
    }

    window.onclick = function (event) {
        if (event.target == document.getElementById('eventModal')) closeModal();
    }

    // --- SPEICHERN ---
    function saveAppointment() {
        const form = document.querySelector('#appointmentForm');
        const formData = new FormData(form);
        const urlSearchParams = new URLSearchParams(formData).toString();
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = '/login';
            return;
        }

        fetch('/calendar/create', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: urlSearchParams
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/calendar';
                } else {
                    alert("Fehler beim Speichern.");
                }
            });
    }

    // --- LÖSCHEN ---
    function deleteAppointment() {
        const id = document.getElementById('eventId').value;
        if (!id) return;

        if (!confirm("Möchtest du diesen Termin wirklich löschen?")) return;

        const token = localStorage.getItem('token');

        fetch('/calendar/delete/' + id, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
            .then(response => {
                if (response.ok) {
                    closeModal();
                    window.location.href = '/calendar';
                } else {
                    alert("Fehler beim Löschen.");
                }
            });
    }

    // Kategorie Auswahl (Farben)
    function selectCategory(value, element) {
        document.getElementById('eventCategory').value = value;
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
        if(element) element.classList.add('selected');
    }
</script>

</body>
</html>